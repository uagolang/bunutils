name: Create Version PR

on:
  push:
    branches:
      - main
    paths:
      - '.changeset/*.md'

jobs:
  version-pr:
    # Only run if there are changeset files (not just README)
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check for changesets
        id: check
        run: |
          CHANGESET_COUNT=$(find .changeset -name "*.md" ! -name "README.md" | wc -l | tr -d ' ')
          echo "count=$CHANGESET_COUNT" >> $GITHUB_OUTPUT
      
      - name: Calculate next version
        if: steps.check.outputs.count != '0'
        id: version
        run: |
          chmod +x scripts/calculate-version.sh
          NEXT_VERSION=$(bash scripts/calculate-version.sh)
          echo "next=$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "Next version will be: $NEXT_VERSION"
      
      - name: Generate changelog preview
        if: steps.check.outputs.count != '0'
        id: changelog
        run: |
          echo "## ${{ steps.version.outputs.next }} - $(date +%Y-%m-%d)" > /tmp/changelog.md
          echo "" >> /tmp/changelog.md
          
          for changeset_file in .changeset/*.md; do
            if [[ "$changeset_file" == *"README.md" ]]; then
              continue
            fi
            
            description=$(sed -n '/^---$/,/^---$/!p' "$changeset_file" | sed '/^---$/d' | sed '/^$/d')
            
            if [ -n "$description" ]; then
              echo "- $description" >> /tmp/changelog.md
            fi
          done
          
          echo "" >> /tmp/changelog.md
      
      - name: Create or update version PR
        if: steps.check.outputs.count != '0'
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          BRANCH_NAME="changeset-release/${{ steps.version.outputs.next }}"
          
          # Check if branch exists
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch $BRANCH_NAME already exists, skipping PR creation"
            exit 0
          fi
          
          # Create new branch
          git checkout -b "$BRANCH_NAME"
          
          # Update CHANGELOG.md
          cat /tmp/changelog.md > CHANGELOG.md.tmp
          if [ -f CHANGELOG.md ]; then
            cat CHANGELOG.md >> CHANGELOG.md.tmp
          else
            echo "# Changelog" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            cat CHANGELOG.md.tmp >> CHANGELOG.md
            rm CHANGELOG.md.tmp
          fi
          if [ -f CHANGELOG.md.tmp ]; then
            mv CHANGELOG.md.tmp CHANGELOG.md
          fi
          
          # Remove changeset files
          find .changeset -name "*.md" ! -name "README.md" -delete
          
          # Commit and push
          git add CHANGELOG.md .changeset/
          git commit -m "chore: version ${{ steps.version.outputs.next }}"
          git push origin "$BRANCH_NAME"
          
          # Create PR using GitHub CLI
          gh pr create \
            --title "Release ${{ steps.version.outputs.next }}" \
            --body "This PR was automatically generated by the changeset workflow.

          ## Changes

          $(cat /tmp/changelog.md)

          ## Release Process

          1. Review the changes in this PR
          2. Merge this PR to \`main\`
          3. Run \`make release\` or manually create a tag for \`${{ steps.version.outputs.next }}\`
          " \
            --base main \
            --head "$BRANCH_NAME"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}


